<!DOCTYPE html>
<html>
<head>
	<script src="tb.js"></script>
	<link rel="stylesheet" href="style.css"/>
</head>
<body>
	<h1>WebRTC, <br/>multipeer demo <br/><cite>by @mr_switch</cite></h1>
<script>

if(!TB.supported){
	document.write('<p style="color:red;">Snap your browser needs getUserMedia and PeerConnection: see <a href="http://www.webrtc.org/running-the-demos">http://www.webrtc.org/running-the-demos</a> for more help</p>');
}


// Create new Video tag
var myvideo = CreateVideoTag();

// Initiate the users own camera
var publisher = TB.initPublisher(myvideo).on({
	started : function(){
		// Flip content horizontally, so for the publisher
		publisher.el.style.webkitTransform = "scaleX(-1)";

		console.log('The users media has been bound to the page');
	},
	failure : function(event){
		console.error( "Camera not available: " + (event&&event.code===1
			?'user denied'
			:'unknown'));
	}
});


var session  = TB.initSession();
session.on({
	sessionConnected : function(event){
		console.log('hurrah, connected to session');
		session.publish(publisher);
	},
	streamCreated : function(event){

		var video = CreateVideoTag();
		video.src = window.URL.createObjectURL(event.stream);
		video.autoplay = true;
		video.onerror = function(){
			alert('streamdestroyed');
		}
	},
	streamDestroyed : function(event){
		console.log('streamdestroyed');
	},
	message : function(event){
		console.log('message');
		console.log(event);
	},
	connectionDestroyed : function(){}
});

session.connect();


//
// Helper function to create clickable images of the video streams coming in.
//
function CreateVideoTag(){
	var div = document.createElement('div');
	var i = document.querySelectorAll('video').length;
	div.className = String.fromCharCode(i +97);
	div.addEventListener('click', function(){
		// swap classNames
		document.querySelector('.a').className = this.className;
		this.className = 'a';
	});

	var video = document.createElement('video');
	video.autoplay = true;
	div.appendChild(video);

	document.body.appendChild(div);

	return video;
}


</script>
</body>
</html>